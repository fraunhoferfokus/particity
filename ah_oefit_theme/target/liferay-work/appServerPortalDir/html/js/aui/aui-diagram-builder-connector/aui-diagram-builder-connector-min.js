YUI.add("aui-diagram-builder-connector",function(e,t){var n=e.Lang,r=n.isArray,i=n.isBoolean,s=n.isObject,o=n.isString,u=e.Array,a=function(e){return e*e*e},f=function(e){return 3*e*e*(1-e)},l=function(e){return 3*e*(1-e)*(1-e)},c=function(e){return(1-e)*(1-e)*(1-e)},h=function(e,t,n,r,i){var s=t[0]*a(e)+r[0]*f(e)+i[0]*l(e)+n[0]*c(e),o=t[1]*a(e)+r[1]*f(e)+i[1]*l(e)+n[1]*c(e);return[s,o]},p=function(t){return e.instanceOf(t,e.Graphic)},d=function(e){return e*180/Math.PI},v=function(e){return e===0?0:e<0?-1:1},m="arrowPoints",g="builder",y="click",b="color",w="connector",E="fill",S="graphic",x="lazyDraw",T="mouseenter",N="mouseleave",t="name",C="nodeName",k="p1",L="p2",A="path",O="selected",M="shape",_="shapeArrow",D="shapeArrowHover",P="shapeArrowSelected",H="shapeHover",B="shapeSelected",j="showName",F="stroke",I="visible",q=e.getClassName,R=q("diagram","builder","connector","name"),U=q("hide");e.PolygonUtil={ARROW_POINTS:[[-12,-6],[-8,0],[-12,6],[6,0]],drawArrow:function(e,t,n,r,i,s){var o=this,u=Math.atan2(i-n,r-t);e.moveTo(r,i),r-=5*Math.cos(u),i-=5*Math.sin(u),o.drawPolygon(e,o.translatePoints(o.rotatePoints(s||o.ARROW_POINTS,u),r,i))},drawPolygon:function(e,t){var n=this;e.moveTo(t[0][0],t[0][1]),u.each(t,function(n,r){r>0&&e.lineTo(t[r][0],t[r][1])}),e.lineTo(t[0][0],t[0][1])},translatePoints:function(e,t,n){var r=this,i=[];return u.each(e,function(r,s){i.push([e[s][0]+t,e[s][1]+n])}),i},rotatePoints:function(e,t){var n=this,r=[];return u.each(e,function(i,s){r.push(n.rotatePoint(t,e[s][0],e[s][1]))}),r},rotatePoint:function(e,t,n){return[t*Math.cos(e)-n*Math.sin(e),t*Math.sin(e)+n*Math.cos(e)]}},e.Connector=e.Base.create("line",e.Base,[],{SERIALIZABLE_ATTRS:[b,x,t,B,H,k,L],shape:null,shapeArrow:null,initializer:function(e){var n=this,r=n.get(x);n.after({nameChange:n._afterNameChange,p1Change:n.draw,p2Change:n.draw,selectedChange:n._afterSelectedChange,showNameChange:n._afterShowNameChange,visibleChange:n._afterVisibleChange}),n._initShapes(),r||n.draw(),n._uiSetVisible(n.get(I)),n._uiSetName(n.get(t)),n._uiSetSelected(n.get(O),!r),n._uiSetShowName(n.get(j))},destructor:function(){var e=this;e.shape.destroy(),e.shapeArrow.destroy(),e.get(C).remove()},draw:function(){var t=this,n=t.shape,r=t.shapeArrow,i=t.get(k),s=t.get(L),o=t.toCoordinate(i),u=t.toCoordinate(s),a=o[0],f=o[1],l=u[0],c=u[1],p=Math.max(Math.abs(a-l)/2,10),g=Math.max(Math.abs(f-c)/2,10),y=null,b=8,w=d(Math.atan2(c-f,l-a)),E=Math.round(Math.abs(w)/(360/b));v(w)<0?y=[[a+p,f,l-p,c,l,c],[a+p,f,l,f-g,l,c],[a,f-g,l,f-g,l,c],[a-p,f,l,f-g,l,c],[a-p,f,l+p,c,l,c]]:y=[[a+p,f,l-p,c,l,c],[a+p,f,l,f+g,l,c],[a,f+g,l,f+g,l,c],[a-p,f,l,f+g,l,c],[a-p,f,l+p,c,l,c]];var S=y[E];n.clear(),n.moveTo(a,f),n.curveTo.apply(n,S),n.end();var x=h(0,[a,f],[l,c],[S[0],S[1]],[S[2],S[3]]),T=h(.075,[a,f],[l,c],[S[0],S[1]],[S[2],S[3]]),N=h(.5,[a,f],[l,c],[S[0],S[1]],[S[2],S[3]]);return r.clear(),e.PolygonUtil.drawArrow(r,T[0],T[1],x[0],x[1],t.get(m)),r.end(),t.get(j)&&t.get(C).center(t.toXY(N)),t},getProperties:function(){var e=this,t=e.getPropertyModel();return u.each(t,function(t){t.value=e.get(t.attributeName)}),t},getPropertyModel:function(){var n=this,r=n.getStrings();return[{attributeName:t,editor:new e.TextCellEditor({validator:{rules:{value:{required:!0}}}}),name:r[t]}]},getStrings:function(){return e.Connector.STRINGS},hide:function(){var e=this;return e.set(I,!1),e},show:function(){var e=this;return e.set(I,!0),e},toCoordinate:function(e){var t=this;return t._offsetXY(e,-1)},toJSON:function(){var e=this,t={};return u.each(e.SERIALIZABLE_ATTRS,function(n){t[n]=e.get(n)}),t},toXY:function(e){var t=this;return t._offsetXY(e,1)},_afterNameChange:function(e){var t=this;t._uiSetName(e.newVal),t.draw()},_afterSelectedChange:function(e){var t=this;t._uiSetSelected(e.newVal)},_afterShowNameChange:function(e){var t=this;t._uiSetShowName(e.newVal)},_afterVisibleChange:function(e){var t=this;t._uiSetVisible(e.newVal)},_initShapes:function(){var t=this,n=t.shape=t.get(S).addShape(t.get(M)),r=t.shapeArrow=t.get(S).addShape(t.get(_));n.on(y,e.bind(t._onShapeClick,t)),n.on(T,e.bind(t._onShapeMouseEnter,t)),n.on(N,e.bind(t._onShapeMouseLeave,t)),r.on(y,e.bind(t._onShapeClick,t)),t.get(C).on(y,e.bind(t._onShapeClick,t))},_offsetXY:function(e,t){var n=this,r=n.get(S).getXY();return[e[0]+r[0]*t,e[1]+r[1]*t]},_onShapeClick:function(e){var t=this,n=t.get(g),r=t.get(O);n&&(e.hasModifier()?n.closeEditProperties():(n.unselectConnectors(),r?n.closeEditProperties():n.editConnector(t))),t.set(O,!r),e.halt()},_onShapeMouseEnter:function(e){var t=this;if(!t.get(O)){var n=t.get(H),r=t.get(D);n&&t._updateShape(t.shape,n,!1),r&&t._updateShape(t.shapeArrow,r,!1)}},_onShapeMouseLeave:function(e){var t=this;t.get(O)||(t._updateShape(t.shape,t.get(M),!1),t._updateShape(t.shapeArrow,t.get(_),!1))},_setNodeName:function(t){var n=this;return e.instanceOf(t,e.Node)||(t=new e.Node.create(t),n.get(g).dropContainer.append(t.unselectable())),t},_setShape:function(t){var n=this;return e.merge({type:A,stroke:{color:n.get(b),weight:2,opacity:1}},t)},_setShapeArrow:function(t){var n=this;return e.merge({type:A,fill:{color:n.get(b),opacity:1},stroke:{color:n.get(b),weight:2,opacity:1}},t)},_uiSetName:function(t){var n=this;n.get(C).html(e.Escape.html(t))},_uiSetSelected:function(e,t){var n=this;n._updateShape(n.shape,e?n.get(B):n.get(M),t),n._updateShape(n.shapeArrow,e?n.get(P):n.get(_),t)},_uiSetShowName:function(e){var t=this;t.get(C).toggleClass(U,!e)},_uiSetVisible:function(e){var t=this;t.shape.set(I,e),t.shapeArrow.set(I,e),t._uiSetShowName(e&&t.get(j))},_updateShape:function(e,t,n){var r=this;t.hasOwnProperty(E)&&e.set(E,t[E]),t.hasOwnProperty(F)&&e.set(F,t[F]),n!==!1&&r.draw()}},{ATTRS:{arrowPoints:{value:e.PolygonUtil.ARROW_POINTS},builder:{},color:{value:"#27aae1",validator:o},graphic:{validator:p},lazyDraw:{value:!1,validator:i},name:{valueFn:function(){var t=this;return w+ ++e.Env._uidx},validator:o},nodeName:{setter:"_setNodeName",value:'<span class="'+R+'"></span>',writeOnce:!0},
p1:{value:[0,0],validator:r},p2:{value:[0,0],validator:r},selected:{value:!1,validator:i},shape:{value:null,setter:"_setShape"},shapeArrow:{value:null,setter:"_setShapeArrow"},shapeArrowHover:{value:{fill:{color:"#ffd700"},stroke:{color:"#ffd700",weight:5,opacity:.8}}},shapeArrowSelected:{value:{fill:{color:"#ff6600"},stroke:{color:"#ff6600",weight:5,opacity:.8}}},shapeHover:{value:{stroke:{color:"#ffd700",weight:5,opacity:.8}}},shapeSelected:{value:{stroke:{color:"#ff6600",weight:5,opacity:.8}}},showName:{validator:i,value:!0},transition:{value:{},validator:s},visible:{validator:i,value:!0}},STRINGS:{name:"Name"}})},"2.0.0",{requires:["arraylist-add","arraylist-filter","escape","json","graphics","dd"],skinnable:!0});

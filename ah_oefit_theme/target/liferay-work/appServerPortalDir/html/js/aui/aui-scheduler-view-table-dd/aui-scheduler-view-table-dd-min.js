YUI.add("aui-scheduler-view-table-dd",function(e,t){var n=e.Lang,r=n.isObject,i=e.DataType.DateMath,s=i.WEEK_LENGTH,o=".",u="scheduler-event",a="scheduler-view",f="boundingBox",l="col",c="colgrid",h="content",p="data",d="dd",v="delegate",m="delegateConfig",g="disabled",y="displayDaysInterval",b="dragNode",w="dragging",E="draggingEvent",S="eventRecorder",x="lasso",T="node",N="offsetHeight",C="offsetWidth",k="proxy",L="proxyNode",A="region",O="rowsContainerNode",M="scheduler",_="startDate",D="table",P="visible",H=e.getClassName,B=H(u),j=H(u,g),F=H(a,D,c),I=H(a,D,w),q=H(a,D,x),R=H(a,D,k,T),U=H(a,D,p,l),z='<div class="'+q+'"></div>',W='<div class="'+R+'"></div>';e.SchedulerTableViewDD=function(){},e.SchedulerTableViewDD.ATTRS={delegateConfig:{value:{},setter:function(t){var n=this;return e.merge({dragConfig:{offsetNode:!1,useShim:!1},bubbleTargets:n,container:n.get(f),nodes:o+B,invalid:"input, select, button, a, textarea, "+o+j},t||{})},validator:r}},e.mix(e.SchedulerTableViewDD.prototype,{initializer:function(){var t=this;t[L]=e.Node.create(W),t.after(t.viewDDBindUI,t,"bindUI"),t.after(t.viewDDRenderUI,t,"renderUI"),t.after(t.viewDDSyncUI,t,"syncUI")},viewDDBindUI:function(){var t=this,n=t.get(M).get(S);n&&n.on({cancel:e.bind(t.removeLasso,t),save:e.bind(t.removeLasso,t)}),t[O].on({mousedown:e.bind(t._onMouseDownGrid,t),mousemove:e.bind(t._onMouseMoveGrid,t),mouseup:e.bind(t._onMouseUpGrid,t)}),t.after("drag:align",t._afterDragAlign),t.on("drag:end",t._onEventDragEnd),t.on("drag:start",t._onEventDragStart)},viewDDRenderUI:function(){var e=this},viewDDSyncUI:function(){var e=this;e._setupDragDrop()},removeLasso:function(){var e=this;e[x]&&e[x].remove()},removeProxy:function(){var e=this;e[L]&&e[L].remove()},renderLasso:function(t,n){var r=this,i=t,o=n;t[1]>n[1]&&(i=n,o=t);var u=i[0],a=i[1],f=o[0],l=o[1],c;r.removeLasso(),r.lasso=e.NodeList.create();for(c=a;c<=l;c++){var h=r.gridCellHeight,p=r.gridCellWidth,d=0,v=h*c;c===a?a===l?(d+=Math.min(u,f)*p,p*=Math.abs(f-u)+1):(d+=u*p,p*=s-u):c===l?p*=f+1:p*=s;var m=e.Node.create(z);r.lasso.push(m),r[O].append(m),m.sizeTo(p,h),m.setXY(r._offsetXY([d,v],1))}},_afterDragAlign:function(t){var n=this,r=t.target,s=n.bodyNode.get(A),o={bottom:t.pageY,left:t.pageX,right:t.pageX,top:t.pageY};if(!e.DOM.inRegion(null,s,!0,o))return;var u=n[E],a=[t.pageX,t.pageY],f=n._findPosition(n._offsetXY(a,-1));if(u&&n._hasLassoChanged(f)){n.lassoLastPosition=f;var l=i.add(n._getPositionDate(f),i.MINUTES,u.getMinutesDuration());n.renderLasso(f,n._getDatePosition(l))}},_findPosition:function(e){var t=this,n=Math.floor(e[0]/t.gridCellWidth),r=Math.floor(e[1]/t.gridCellHeight);return[n,r]},_getDatePosition:function(e){var t=this,n=t._findCurrentIntervalStart(),r=i.getDayOffset(e,n),o=[];return o[1]=Math.floor(r/s),o[0]=r%s,o},_getPositionDate:function(e){var t=this,n=t._findCurrentIntervalStart(),r=i.add(n,i.DAY,t._getCellIndex(e));return r.setHours(0,0,0,0),r},_hasLassoChanged:function(e){var t=this,n=t.lassoLastPosition||t.lassoStartPosition;return n&&(e[0]!==n[0]||e[1]!==n[1])},_offsetXY:function(e,t){var n=this,r=n[O].getXY();return[e[0]+r[0]*t,e[1]+r[1]*t]},_onEventDragEnd:function(e){var t=this,n=t[E];if(n){var r=t._getPositionDate(t.lassoLastPosition);i.copyHours(r,n.get(_)),n.move(r),n.set(P,!0,{silent:!0}),t[O].removeClass(I).unselectable(),e.target.set(b,t.originalDragNode),t.removeLasso(),t.removeProxy(),t.get(M).syncEventsUI()}t[E]=null},_onEventDragStart:function(e){var t=this,n=t[E]=t[v][d].get(T).getData(u);if(n){t._syncCellDimensions();var r=[e.pageX,e.pageY],s=t._findPosition(t._offsetXY(r,-1)),o=i.add(t._getPositionDate(s),i.MINUTES,n.getMinutesDuration());t.renderLasso(s,t._getDatePosition(o)),t._syncProxyNodeUI(n),n.set(P,!1,{silent:!0}),t.lassoStartPosition=t.lassoLastPosition=s,t[O].addClass(I).unselectable(),t.originalDragNode=e.target.get(b),e.target.set(b,t[L])}},_onMouseDownGrid:function(e){var t=this,n=t.get(M),r=n.get(S),i=e.target;if(r&&!n.get(g)&&i.test([o+F,o+U].join())){t._recording=!0,t._syncCellDimensions();var s=t._offsetXY([e.pageX,e.pageY],-1);t.lassoStartPosition=t.lassoLastPosition=t._findPosition(s),t.renderLasso(t.lassoStartPosition,t.lassoLastPosition),t[O].unselectable()}},_onMouseMoveGrid:function(e){var t=this,n=e.currentTarget,r=[e.pageX,e.pageY],i=t._findPosition(t._offsetXY(r,-1));t._recording&&t._hasLassoChanged(i)&&(t.lassoLastPosition=i,t.renderLasso(t.lassoStartPosition,i))},_onMouseUpGrid:function(e){var t=this,n=t.get(M),r=n.get(S);if(r&&t._recording&&!n.get(g)){var i=t._getPositionDate(t.lassoStartPosition),s=t._getPositionDate(t.lassoLastPosition),o=new Date(Math.min(i,s));o.setHours(0,0,0);var u=new Date(Math.max(i,s));u.setHours(23,59,59),r.setAttrs({allDay:!0,endDate:u,startDate:o},{silent:!0}),r.showPopover(t.lasso),t._recording=!1}},_setupDragDrop:function(){var t=this;t[v]||(t[v]=new e.DD.Delegate(t.get(m)));var n=t[v][d];n.unplug(e.Plugin.DDNodeScroll),n.unplug(e.Plugin.DDProxy),n.plug(e.Plugin.DDNodeScroll,{node:t.bodyNode,scrollDelay:150}),n.plug(e.Plugin.DDProxy,{moveOnEnd:!1,positionProxy:!1})},_syncCellDimensions:function(){var e=this,t=e.get(y),n=Math.ceil(t/s),r=Math.min(t,s);e.gridCellHeight=e[O].get(N)/n,e.gridCellWidth=e[O].get(C)/r},_syncProxyNodeUI:function(e){var t=this,n=e.get(T).item(0),r=e.get(T).item(1);t[L].setStyles({backgroundColor:n.getStyle("backgroundColor"),color:n.getStyle("color"),display:"block"});if(!r||!r.test(":visible")){var i=n.get(C);t[L].set(C,i)}t[L].appendTo(t[O]),t[L].setContent(e.get(h))}}),e.Base.mix(e.SchedulerTableView,[e.SchedulerTableViewDD])},"2.0.0",{requires:["dd-drag","dd-delegate","dd-drop","aui-scheduler-view-table"]});

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<title>CustomPortalServiceHandler xref</title>
<link type="text/css" rel="stylesheet" href="../../../../../../stylesheet.css" />
</head>
<body>
<div id="overview"><a href="../../../../../../../apidocs/de/fraunhofer/fokus/oefit/adhoc/custom/CustomPortalServiceHandler.html">View Javadoc</a></div><pre>
<a class="jxr_linenumber" name="L1" href="#L1">1</a>   <em class="jxr_comment">/*</em>
<a class="jxr_linenumber" name="L2" href="#L2">2</a>   <em class="jxr_comment"> * Copyright (c) 2015-2015 Fraunhofer Institute FOKUS. All rights reserved.</em>
<a class="jxr_linenumber" name="L3" href="#L3">3</a>   <em class="jxr_comment"> * </em>
<a class="jxr_linenumber" name="L4" href="#L4">4</a>   <em class="jxr_comment"> * Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:</em>
<a class="jxr_linenumber" name="L5" href="#L5">5</a>   <em class="jxr_comment"> * </em>
<a class="jxr_linenumber" name="L6" href="#L6">6</a>   <em class="jxr_comment"> * 1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.</em>
<a class="jxr_linenumber" name="L7" href="#L7">7</a>   <em class="jxr_comment"> * </em>
<a class="jxr_linenumber" name="L8" href="#L8">8</a>   <em class="jxr_comment"> * 2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.</em>
<a class="jxr_linenumber" name="L9" href="#L9">9</a>   <em class="jxr_comment"> * </em>
<a class="jxr_linenumber" name="L10" href="#L10">10</a>  <em class="jxr_comment"> * 3. All advertising materials mentioning features or use of this software must display the following acknowledgement:</em>
<a class="jxr_linenumber" name="L11" href="#L11">11</a>  <em class="jxr_comment"> * This product includes software developed by the Fraunhofer Institute FOKUS.</em>
<a class="jxr_linenumber" name="L12" href="#L12">12</a>  <em class="jxr_comment"> * </em>
<a class="jxr_linenumber" name="L13" href="#L13">13</a>  <em class="jxr_comment"> * 4. Neither the name of the Fraunhofer Society nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.</em>
<a class="jxr_linenumber" name="L14" href="#L14">14</a>  <em class="jxr_comment"> * </em>
<a class="jxr_linenumber" name="L15" href="#L15">15</a>  <em class="jxr_comment"> * THIS SOFTWARE IS PROVIDED BY THE FRAUNHOFER SOCIETY "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL COPYRIGHT HOLDER BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</em>
<a class="jxr_linenumber" name="L16" href="#L16">16</a>  <em class="jxr_comment"> * </em>
<a class="jxr_linenumber" name="L17" href="#L17">17</a>  <em class="jxr_comment"> * </em>
<a class="jxr_linenumber" name="L18" href="#L18">18</a>  <em class="jxr_comment"> * @author sma</em>
<a class="jxr_linenumber" name="L19" href="#L19">19</a>  <em class="jxr_comment"> */</em>
<a class="jxr_linenumber" name="L20" href="#L20">20</a>  <strong class="jxr_keyword">package</strong> de.fraunhofer.fokus.oefit.adhoc.custom;
<a class="jxr_linenumber" name="L21" href="#L21">21</a>  
<a class="jxr_linenumber" name="L22" href="#L22">22</a>  <strong class="jxr_keyword">import</strong> java.util.Enumeration;
<a class="jxr_linenumber" name="L23" href="#L23">23</a>  <strong class="jxr_keyword">import</strong> java.util.List;
<a class="jxr_linenumber" name="L24" href="#L24">24</a>  <strong class="jxr_keyword">import</strong> java.util.Locale;
<a class="jxr_linenumber" name="L25" href="#L25">25</a>  
<a class="jxr_linenumber" name="L26" href="#L26">26</a>  <strong class="jxr_keyword">import</strong> javax.portlet.ActionRequest;
<a class="jxr_linenumber" name="L27" href="#L27">27</a>  <strong class="jxr_keyword">import</strong> javax.portlet.PortletPreferences;
<a class="jxr_linenumber" name="L28" href="#L28">28</a>  
<a class="jxr_linenumber" name="L29" href="#L29">29</a>  <strong class="jxr_keyword">import</strong> org.springframework.validation.BindingResult;
<a class="jxr_linenumber" name="L30" href="#L30">30</a>  
<a class="jxr_linenumber" name="L31" href="#L31">31</a>  <strong class="jxr_keyword">import</strong> com.liferay.counter.service.CounterLocalServiceUtil;
<a class="jxr_linenumber" name="L32" href="#L32">32</a>  <strong class="jxr_keyword">import</strong> com.liferay.portal.NoSuchUserException;
<a class="jxr_linenumber" name="L33" href="#L33">33</a>  <strong class="jxr_keyword">import</strong> com.liferay.portal.kernel.dao.orm.QueryUtil;
<a class="jxr_linenumber" name="L34" href="#L34">34</a>  <strong class="jxr_keyword">import</strong> com.liferay.portal.kernel.exception.PortalException;
<a class="jxr_linenumber" name="L35" href="#L35">35</a>  <strong class="jxr_keyword">import</strong> com.liferay.portal.kernel.exception.SystemException;
<a class="jxr_linenumber" name="L36" href="#L36">36</a>  <strong class="jxr_keyword">import</strong> com.liferay.portal.kernel.log.Log;
<a class="jxr_linenumber" name="L37" href="#L37">37</a>  <strong class="jxr_keyword">import</strong> com.liferay.portal.kernel.log.LogFactoryUtil;
<a class="jxr_linenumber" name="L38" href="#L38">38</a>  <strong class="jxr_keyword">import</strong> com.liferay.portal.kernel.repository.model.Folder;
<a class="jxr_linenumber" name="L39" href="#L39">39</a>  <strong class="jxr_keyword">import</strong> com.liferay.portal.kernel.util.PrefsPropsUtil;
<a class="jxr_linenumber" name="L40" href="#L40">40</a>  <strong class="jxr_keyword">import</strong> com.liferay.portal.model.PortalPreferences;
<a class="jxr_linenumber" name="L41" href="#L41">41</a>  <strong class="jxr_keyword">import</strong> com.liferay.portal.model.Role;
<a class="jxr_linenumber" name="L42" href="#L42">42</a>  <strong class="jxr_keyword">import</strong> com.liferay.portal.model.RoleConstants;
<a class="jxr_linenumber" name="L43" href="#L43">43</a>  <strong class="jxr_keyword">import</strong> com.liferay.portal.model.User;
<a class="jxr_linenumber" name="L44" href="#L44">44</a>  <strong class="jxr_keyword">import</strong> com.liferay.portal.security.permission.ActionKeys;
<a class="jxr_linenumber" name="L45" href="#L45">45</a>  <strong class="jxr_keyword">import</strong> com.liferay.portal.service.PortalPreferencesLocalServiceUtil;
<a class="jxr_linenumber" name="L46" href="#L46">46</a>  <strong class="jxr_keyword">import</strong> com.liferay.portal.service.ResourcePermissionServiceUtil;
<a class="jxr_linenumber" name="L47" href="#L47">47</a>  <strong class="jxr_keyword">import</strong> com.liferay.portal.service.RoleLocalServiceUtil;
<a class="jxr_linenumber" name="L48" href="#L48">48</a>  <strong class="jxr_keyword">import</strong> com.liferay.portal.service.ServiceContext;
<a class="jxr_linenumber" name="L49" href="#L49">49</a>  <strong class="jxr_keyword">import</strong> com.liferay.portal.service.UserLocalServiceUtil;
<a class="jxr_linenumber" name="L50" href="#L50">50</a>  <strong class="jxr_keyword">import</strong> com.liferay.portal.theme.ThemeDisplay;
<a class="jxr_linenumber" name="L51" href="#L51">51</a>  <strong class="jxr_keyword">import</strong> com.liferay.portal.util.PortalUtil;
<a class="jxr_linenumber" name="L52" href="#L52">52</a>  <strong class="jxr_keyword">import</strong> com.liferay.portlet.documentlibrary.model.DLFolder;
<a class="jxr_linenumber" name="L53" href="#L53">53</a>  <strong class="jxr_keyword">import</strong> com.liferay.portlet.documentlibrary.service.DLAppServiceUtil;
<a class="jxr_linenumber" name="L54" href="#L54">54</a>  
<a class="jxr_linenumber" name="L55" href="#L55">55</a>  <strong class="jxr_keyword">import</strong> de.fraunhofer.fokus.oefit.adhoc.forms.ProfileForm;
<a class="jxr_linenumber" name="L56" href="#L56">56</a>  <strong class="jxr_keyword">import</strong> de.fraunhofer.fokus.oefit.adhoc.model.custom.MessageComposer;
<a class="jxr_linenumber" name="L57" href="#L57">57</a>  <strong class="jxr_keyword">import</strong> de.fraunhofer.fokus.oefit.adhoc.service.AHConfigLocalServiceUtil;
<a class="jxr_linenumber" name="L58" href="#L58">58</a>  <strong class="jxr_keyword">import</strong> de.fraunhofer.fokus.oefit.adhoc.service.AHOrgLocalServiceUtil;
<a class="jxr_linenumber" name="L59" href="#L59">59</a>  <strong class="jxr_keyword">import</strong> de.fraunhofer.fokus.oefit.adhoc.socialize.SocialMediaFactory;
<a class="jxr_linenumber" name="L60" href="#L60">60</a>  
<a class="jxr_linenumber" name="L61" href="#L61">61</a>  <em class="jxr_comment">// TODO: Auto-generated Javadoc</em>
<a class="jxr_linenumber" name="L62" href="#L62">62</a>  <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L63" href="#L63">63</a>  <em class="jxr_javadoccomment"> * The Class CustomPortalServiceHandler.</em>
<a class="jxr_linenumber" name="L64" href="#L64">64</a>  <em class="jxr_javadoccomment"> */</em>
<a class="jxr_linenumber" name="L65" href="#L65">65</a>  <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">class</strong> <a href="../../../../../../de/fraunhofer/fokus/oefit/adhoc/custom/CustomPortalServiceHandler.html">CustomPortalServiceHandler</a> {
<a class="jxr_linenumber" name="L66" href="#L66">66</a>  
<a class="jxr_linenumber" name="L67" href="#L67">67</a>  	<strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> Log	m_objLog	= LogFactoryUtil
<a class="jxr_linenumber" name="L68" href="#L68">68</a>  	                                                .getLog(CustomPortalServiceHandler.<strong class="jxr_keyword">class</strong>);
<a class="jxr_linenumber" name="L69" href="#L69">69</a>  
<a class="jxr_linenumber" name="L70" href="#L70">70</a>  	<strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> Boolean	 m_bInitialized	= <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L71" href="#L71">71</a>  
<a class="jxr_linenumber" name="L72" href="#L72">72</a>  	<em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L73" href="#L73">73</a>  <em class="jxr_javadoccomment">	 * Change user profile.</em>
<a class="jxr_linenumber" name="L74" href="#L74">74</a>  <em class="jxr_javadoccomment">	 *</em>
<a class="jxr_linenumber" name="L75" href="#L75">75</a>  <em class="jxr_javadoccomment">	 * @param oldUser the old user</em>
<a class="jxr_linenumber" name="L76" href="#L76">76</a>  <em class="jxr_javadoccomment">	 * @param newProfile the new profile</em>
<a class="jxr_linenumber" name="L77" href="#L77">77</a>  <em class="jxr_javadoccomment">	 * @param result the result</em>
<a class="jxr_linenumber" name="L78" href="#L78">78</a>  <em class="jxr_javadoccomment">	 */</em>
<a class="jxr_linenumber" name="L79" href="#L79">79</a>  	<strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">void</strong> changeUserProfile(User oldUser,
<a class="jxr_linenumber" name="L80" href="#L80">80</a>  	        <strong class="jxr_keyword">final</strong> ProfileForm newProfile, <strong class="jxr_keyword">final</strong> BindingResult result) {
<a class="jxr_linenumber" name="L81" href="#L81">81</a>  		<strong class="jxr_keyword">final</strong> String oldMail = oldUser.getEmailAddress();
<a class="jxr_linenumber" name="L82" href="#L82">82</a>  		<strong class="jxr_keyword">final</strong> String newMail = newProfile.getMail();
<a class="jxr_linenumber" name="L83" href="#L83">83</a>  		<strong class="jxr_keyword">if</strong> (!oldMail.toLowerCase().trim().equals(newMail.toLowerCase().trim())) {
<a class="jxr_linenumber" name="L84" href="#L84">84</a>  			m_objLog.debug(<span class="jxr_string">"User mail changed!"</span>);
<a class="jxr_linenumber" name="L85" href="#L85">85</a>  			<strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L86" href="#L86">86</a>  				oldUser = UserLocalServiceUtil.updateEmailAddress(
<a class="jxr_linenumber" name="L87" href="#L87">87</a>  				        oldUser.getUserId(), oldUser.getPassword(),
<a class="jxr_linenumber" name="L88" href="#L88">88</a>  				        newMail.trim(), newMail.trim());
<a class="jxr_linenumber" name="L89" href="#L89">89</a>  			} <strong class="jxr_keyword">catch</strong> (<strong class="jxr_keyword">final</strong> Throwable e) {
<a class="jxr_linenumber" name="L90" href="#L90">90</a>  				result.rejectValue(<span class="jxr_string">"mail"</span>, <span class="jxr_string">"notExistentErrorCode"</span>,
<a class="jxr_linenumber" name="L91" href="#L91">91</a>  				        <span class="jxr_string">"common.form.profile.field.mail.unknown"</span>);
<a class="jxr_linenumber" name="L92" href="#L92">92</a>  				e.printStackTrace();
<a class="jxr_linenumber" name="L93" href="#L93">93</a>  			}
<a class="jxr_linenumber" name="L94" href="#L94">94</a>  			<strong class="jxr_keyword">if</strong> (oldUser != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L95" href="#L95">95</a>  				AHOrgLocalServiceUtil.updateOwner(oldMail, newMail.trim());
<a class="jxr_linenumber" name="L96" href="#L96">96</a>  			}
<a class="jxr_linenumber" name="L97" href="#L97">97</a>  		} <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L98" href="#L98">98</a>  			m_objLog.debug(<span class="jxr_string">"User mail not changed!"</span>);
<a class="jxr_linenumber" name="L99" href="#L99">99</a>  		}
<a class="jxr_linenumber" name="L100" href="#L100">100</a> 		<strong class="jxr_keyword">if</strong> (newProfile.getPass1().equals(newProfile.getPass2())) {
<a class="jxr_linenumber" name="L101" href="#L101">101</a> 			<strong class="jxr_keyword">if</strong> (newProfile.getPass1().replaceAll(<span class="jxr_string">"&#92;&#92;*"</span>, <span class="jxr_string">""</span>).length() &gt; 0) {
<a class="jxr_linenumber" name="L102" href="#L102">102</a> 				m_objLog.debug(<span class="jxr_string">"User password changed!"</span>);
<a class="jxr_linenumber" name="L103" href="#L103">103</a> 				<strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L104" href="#L104">104</a> 					UserLocalServiceUtil.updatePassword(oldUser.getUserId(),
<a class="jxr_linenumber" name="L105" href="#L105">105</a> 					        newProfile.getPass1(),
<a class="jxr_linenumber" name="L106" href="#L106">106</a> 					        newProfile.getPass1(), false);
<a class="jxr_linenumber" name="L107" href="#L107">107</a> 				} <strong class="jxr_keyword">catch</strong> (<strong class="jxr_keyword">final</strong> Throwable e) {
<a class="jxr_linenumber" name="L108" href="#L108">108</a> 					result.rejectValue(<span class="jxr_string">"mail"</span>, <span class="jxr_string">"notExistentErrorCode"</span>,
<a class="jxr_linenumber" name="L109" href="#L109">109</a> 					        <span class="jxr_string">"common.form.profile.field.pass1.unknown"</span>);
<a class="jxr_linenumber" name="L110" href="#L110">110</a> 					m_objLog.error(e);
<a class="jxr_linenumber" name="L111" href="#L111">111</a> 				}
<a class="jxr_linenumber" name="L112" href="#L112">112</a> 
<a class="jxr_linenumber" name="L113" href="#L113">113</a> 			} <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L114" href="#L114">114</a> 				m_objLog.debug(<span class="jxr_string">"User password not changed!"</span>);
<a class="jxr_linenumber" name="L115" href="#L115">115</a> 			}
<a class="jxr_linenumber" name="L116" href="#L116">116</a> 		}
<a class="jxr_linenumber" name="L117" href="#L117">117</a> 	}
<a class="jxr_linenumber" name="L118" href="#L118">118</a> 
<a class="jxr_linenumber" name="L119" href="#L119">119</a> 	<em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L120" href="#L120">120</a> <em class="jxr_javadoccomment">	 * Check init.</em>
<a class="jxr_linenumber" name="L121" href="#L121">121</a> <em class="jxr_javadoccomment">	 *</em>
<a class="jxr_linenumber" name="L122" href="#L122">122</a> <em class="jxr_javadoccomment">	 * @param themeDisplay the theme display</em>
<a class="jxr_linenumber" name="L123" href="#L123">123</a> <em class="jxr_javadoccomment">	 */</em>
<a class="jxr_linenumber" name="L124" href="#L124">124</a> 	<strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">synchronized</strong> <strong class="jxr_keyword">void</strong> checkInit(<strong class="jxr_keyword">final</strong> ThemeDisplay themeDisplay) {
<a class="jxr_linenumber" name="L125" href="#L125">125</a> 		<strong class="jxr_keyword">if</strong> (!isSystemInitialized()) {
<a class="jxr_linenumber" name="L126" href="#L126">126</a> 
<a class="jxr_linenumber" name="L127" href="#L127">127</a> 			<strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L128" href="#L128">128</a> 
<a class="jxr_linenumber" name="L129" href="#L129">129</a> 				<strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">long</strong> groupId = themeDisplay.getScopeGroupId();
<a class="jxr_linenumber" name="L130" href="#L130">130</a> 				<strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">long</strong> userId = themeDisplay.getUserId();
<a class="jxr_linenumber" name="L131" href="#L131">131</a> 
<a class="jxr_linenumber" name="L132" href="#L132">132</a> 				<strong class="jxr_keyword">final</strong> ServiceContext ctx = <strong class="jxr_keyword">new</strong> ServiceContext();
<a class="jxr_linenumber" name="L133" href="#L133">133</a> 				ctx.setUserId(userId);
<a class="jxr_linenumber" name="L134" href="#L134">134</a> 				ctx.setScopeGroupId(groupId);
<a class="jxr_linenumber" name="L135" href="#L135">135</a> 				ctx.setAddGroupPermissions(<strong class="jxr_keyword">true</strong>);
<a class="jxr_linenumber" name="L136" href="#L136">136</a> 				ctx.setAddGuestPermissions(<strong class="jxr_keyword">true</strong>);
<a class="jxr_linenumber" name="L137" href="#L137">137</a> 				<em class="jxr_comment">// ctx.setWorkflowAction(WorkflowConstants.ACTION_PUBLISH);</em>
<a class="jxr_linenumber" name="L138" href="#L138">138</a> 
<a class="jxr_linenumber" name="L139" href="#L139">139</a> 				Folder parent = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L140" href="#L140">140</a> 				<strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L141" href="#L141">141</a> 					parent = DLAppServiceUtil.getFolder(groupId, 0,
<a class="jxr_linenumber" name="L142" href="#L142">142</a> 					        Constants.ORGANISATION_LOGO_FOLDER);
<a class="jxr_linenumber" name="L143" href="#L143">143</a> 				} <strong class="jxr_keyword">catch</strong> (<strong class="jxr_keyword">final</strong> Throwable t) {
<a class="jxr_linenumber" name="L144" href="#L144">144</a> 				}
<a class="jxr_linenumber" name="L145" href="#L145">145</a> 
<a class="jxr_linenumber" name="L146" href="#L146">146</a> 				<strong class="jxr_keyword">if</strong> (parent == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L147" href="#L147">147</a> 					parent = DLAppServiceUtil.addFolder(groupId, 0,
<a class="jxr_linenumber" name="L148" href="#L148">148</a> 					        Constants.ORGANISATION_LOGO_FOLDER, <span class="jxr_string">""</span>, ctx);
<a class="jxr_linenumber" name="L149" href="#L149">149</a> 					m_objLog.info(<span class="jxr_string">"Folder "</span>
<a class="jxr_linenumber" name="L150" href="#L150">150</a> 					        + Constants.ORGANISATION_LOGO_FOLDER
<a class="jxr_linenumber" name="L151" href="#L151">151</a> 					        + <span class="jxr_string">" created ...."</span>);
<a class="jxr_linenumber" name="L152" href="#L152">152</a> 				} <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L153" href="#L153">153</a> 					m_objLog.info(<span class="jxr_string">"Folder "</span>
<a class="jxr_linenumber" name="L154" href="#L154">154</a> 					        + Constants.ORGANISATION_LOGO_FOLDER
<a class="jxr_linenumber" name="L155" href="#L155">155</a> 					        + <span class="jxr_string">" already existing ...."</span>);
<a class="jxr_linenumber" name="L156" href="#L156">156</a> 				}
<a class="jxr_linenumber" name="L157" href="#L157">157</a> 
<a class="jxr_linenumber" name="L158" href="#L158">158</a> 				<strong class="jxr_keyword">final</strong> String[] actionids = <strong class="jxr_keyword">new</strong> String[2];
<a class="jxr_linenumber" name="L159" href="#L159">159</a> 				<strong class="jxr_keyword">final</strong> Role guestRole = RoleLocalServiceUtil.getRole(
<a class="jxr_linenumber" name="L160" href="#L160">160</a> 				        PortalUtil.getDefaultCompanyId(), RoleConstants.GUEST);
<a class="jxr_linenumber" name="L161" href="#L161">161</a> 				actionids[0] = ActionKeys.VIEW;
<a class="jxr_linenumber" name="L162" href="#L162">162</a> 				actionids[1] = ActionKeys.ACCESS;
<a class="jxr_linenumber" name="L163" href="#L163">163</a> 				<em class="jxr_comment">// actionids[2] = ActionKeys.ADD_FILE;</em>
<a class="jxr_linenumber" name="L164" href="#L164">164</a> 
<a class="jxr_linenumber" name="L165" href="#L165">165</a> 				ResourcePermissionServiceUtil.setIndividualResourcePermissions(
<a class="jxr_linenumber" name="L166" href="#L166">166</a> 				        parent.getGroupId(), parent.getCompanyId(),
<a class="jxr_linenumber" name="L167" href="#L167">167</a> 				        DLFolder.<strong class="jxr_keyword">class</strong>.getName(), parent.getFolderId() + <span class="jxr_string">""</span>,
<a class="jxr_linenumber" name="L168" href="#L168">168</a> 				        guestRole.getRoleId(), actionids);
<a class="jxr_linenumber" name="L169" href="#L169">169</a> 
<a class="jxr_linenumber" name="L170" href="#L170">170</a> 				setConfig(E_ConfigKey.INITFLAG, <span class="jxr_string">"true"</span>);
<a class="jxr_linenumber" name="L171" href="#L171">171</a> 				m_bInitialized = <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="L172" href="#L172">172</a> 
<a class="jxr_linenumber" name="L173" href="#L173">173</a> 			} <strong class="jxr_keyword">catch</strong> (<strong class="jxr_keyword">final</strong> Throwable t) {
<a class="jxr_linenumber" name="L174" href="#L174">174</a> 				m_objLog.error(t);
<a class="jxr_linenumber" name="L175" href="#L175">175</a> 			}
<a class="jxr_linenumber" name="L176" href="#L176">176</a> 
<a class="jxr_linenumber" name="L177" href="#L177">177</a> 		}
<a class="jxr_linenumber" name="L178" href="#L178">178</a> 	}
<a class="jxr_linenumber" name="L179" href="#L179">179</a> 
<a class="jxr_linenumber" name="L180" href="#L180">180</a> 	<em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L181" href="#L181">181</a> <em class="jxr_javadoccomment">	 * Check role.</em>
<a class="jxr_linenumber" name="L182" href="#L182">182</a> <em class="jxr_javadoccomment">	 *</em>
<a class="jxr_linenumber" name="L183" href="#L183">183</a> <em class="jxr_javadoccomment">	 * @param companyId the company id</em>
<a class="jxr_linenumber" name="L184" href="#L184">184</a> <em class="jxr_javadoccomment">	 * @param roleName the role name</em>
<a class="jxr_linenumber" name="L185" href="#L185">185</a> <em class="jxr_javadoccomment">	 * @return the role</em>
<a class="jxr_linenumber" name="L186" href="#L186">186</a> <em class="jxr_javadoccomment">	 */</em>
<a class="jxr_linenumber" name="L187" href="#L187">187</a> 	<strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">static</strong> Role checkRole(<strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">long</strong> companyId, <strong class="jxr_keyword">final</strong> String roleName) {
<a class="jxr_linenumber" name="L188" href="#L188">188</a> 		Role result = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L189" href="#L189">189</a> 
<a class="jxr_linenumber" name="L190" href="#L190">190</a> 		Role role = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L191" href="#L191">191</a> 		<strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L192" href="#L192">192</a> 			role = RoleLocalServiceUtil.fetchRole(companyId,
<a class="jxr_linenumber" name="L193" href="#L193">193</a> 			        Constants.DEFAULT_ROLE_ORGANIZATION);
<a class="jxr_linenumber" name="L194" href="#L194">194</a> 			result = role;
<a class="jxr_linenumber" name="L195" href="#L195">195</a> 		} <strong class="jxr_keyword">catch</strong> (<strong class="jxr_keyword">final</strong> SystemException e) {
<a class="jxr_linenumber" name="L196" href="#L196">196</a> 		}
<a class="jxr_linenumber" name="L197" href="#L197">197</a> 		<strong class="jxr_keyword">if</strong> (role == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L198" href="#L198">198</a> 			<strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L199" href="#L199">199</a> 				role = RoleLocalServiceUtil.createRole(CounterLocalServiceUtil
<a class="jxr_linenumber" name="L200" href="#L200">200</a> 				        .increment(Role.<strong class="jxr_keyword">class</strong>.getName()));
<a class="jxr_linenumber" name="L201" href="#L201">201</a> 				role.setName(roleName);
<a class="jxr_linenumber" name="L202" href="#L202">202</a> 				role.setCompanyId(companyId);
<a class="jxr_linenumber" name="L203" href="#L203">203</a> 				role.setDescription(roleName);
<a class="jxr_linenumber" name="L204" href="#L204">204</a> 				role.setTitle(roleName);
<a class="jxr_linenumber" name="L205" href="#L205">205</a> 				role.setType(RoleConstants.TYPE_REGULAR);
<a class="jxr_linenumber" name="L206" href="#L206">206</a> 				result = RoleLocalServiceUtil.updateRole(role);
<a class="jxr_linenumber" name="L207" href="#L207">207</a> 			} <strong class="jxr_keyword">catch</strong> (<strong class="jxr_keyword">final</strong> Throwable t) {
<a class="jxr_linenumber" name="L208" href="#L208">208</a> 				m_objLog.error(t);
<a class="jxr_linenumber" name="L209" href="#L209">209</a> 			}
<a class="jxr_linenumber" name="L210" href="#L210">210</a> 		}
<a class="jxr_linenumber" name="L211" href="#L211">211</a> 
<a class="jxr_linenumber" name="L212" href="#L212">212</a> 		<strong class="jxr_keyword">return</strong> result;
<a class="jxr_linenumber" name="L213" href="#L213">213</a> 	}
<a class="jxr_linenumber" name="L214" href="#L214">214</a> 
<a class="jxr_linenumber" name="L215" href="#L215">215</a> 	<em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L216" href="#L216">216</a> <em class="jxr_javadoccomment">	 * Creates the portal user.</em>
<a class="jxr_linenumber" name="L217" href="#L217">217</a> <em class="jxr_javadoccomment">	 *</em>
<a class="jxr_linenumber" name="L218" href="#L218">218</a> <em class="jxr_javadoccomment">	 * @param firstName the first name</em>
<a class="jxr_linenumber" name="L219" href="#L219">219</a> <em class="jxr_javadoccomment">	 * @param lastName the last name</em>
<a class="jxr_linenumber" name="L220" href="#L220">220</a> <em class="jxr_javadoccomment">	 * @param mail the mail</em>
<a class="jxr_linenumber" name="L221" href="#L221">221</a> <em class="jxr_javadoccomment">	 * @param companyId the company id</em>
<a class="jxr_linenumber" name="L222" href="#L222">222</a> <em class="jxr_javadoccomment">	 * @param locale the locale</em>
<a class="jxr_linenumber" name="L223" href="#L223">223</a> <em class="jxr_javadoccomment">	 * @return the user</em>
<a class="jxr_linenumber" name="L224" href="#L224">224</a> <em class="jxr_javadoccomment">	 */</em>
<a class="jxr_linenumber" name="L225" href="#L225">225</a> 	<strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">static</strong> User createPortalUser(<strong class="jxr_keyword">final</strong> String firstName,
<a class="jxr_linenumber" name="L226" href="#L226">226</a> 	        <strong class="jxr_keyword">final</strong> String lastName, <strong class="jxr_keyword">final</strong> String mail, <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">long</strong> companyId,
<a class="jxr_linenumber" name="L227" href="#L227">227</a> 	        <strong class="jxr_keyword">final</strong> Locale locale) {
<a class="jxr_linenumber" name="L228" href="#L228">228</a> 
<a class="jxr_linenumber" name="L229" href="#L229">229</a> 		User user = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L230" href="#L230">230</a> 		<strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L231" href="#L231">231</a> 			<strong class="jxr_keyword">final</strong> Role orgRole = checkRole(companyId,
<a class="jxr_linenumber" name="L232" href="#L232">232</a> 			        Constants.DEFAULT_ROLE_ORGANIZATION);
<a class="jxr_linenumber" name="L233" href="#L233">233</a> 
<a class="jxr_linenumber" name="L234" href="#L234">234</a> 			<strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L235" href="#L235">235</a> 				user = UserLocalServiceUtil.getUserByEmailAddress(companyId,
<a class="jxr_linenumber" name="L236" href="#L236">236</a> 				        mail);
<a class="jxr_linenumber" name="L237" href="#L237">237</a> 			} <strong class="jxr_keyword">catch</strong> (<strong class="jxr_keyword">final</strong> Throwable t) {
<a class="jxr_linenumber" name="L238" href="#L238">238</a> 			}
<a class="jxr_linenumber" name="L239" href="#L239">239</a> 
<a class="jxr_linenumber" name="L240" href="#L240">240</a> 			<strong class="jxr_keyword">if</strong> (user == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L241" href="#L241">241</a> 				user = UserLocalServiceUtil.addUser(0, companyId, <strong class="jxr_keyword">true</strong>, <strong class="jxr_keyword">null</strong>,
<a class="jxr_linenumber" name="L242" href="#L242">242</a> 				        <strong class="jxr_keyword">null</strong>,
<a class="jxr_linenumber" name="L243" href="#L243">243</a> 				        <strong class="jxr_keyword">true</strong>, <strong class="jxr_keyword">null</strong>, mail, 0L, <span class="jxr_string">""</span>, locale, firstName, <span class="jxr_string">""</span>,
<a class="jxr_linenumber" name="L244" href="#L244">244</a> 				        lastName,
<a class="jxr_linenumber" name="L245" href="#L245">245</a> 				        0, 0, false, 0, 1, 1970, <span class="jxr_string">""</span>, <strong class="jxr_keyword">null</strong>, <strong class="jxr_keyword">null</strong>,
<a class="jxr_linenumber" name="L246" href="#L246">246</a> 				        <strong class="jxr_keyword">new</strong> <strong class="jxr_keyword">long</strong>[] { orgRole.getRoleId() }, <strong class="jxr_keyword">null</strong>, <strong class="jxr_keyword">true</strong>,
<a class="jxr_linenumber" name="L247" href="#L247">247</a> 				        <strong class="jxr_keyword">new</strong> ServiceContext());
<a class="jxr_linenumber" name="L248" href="#L248">248</a> 			}
<a class="jxr_linenumber" name="L249" href="#L249">249</a> 
<a class="jxr_linenumber" name="L250" href="#L250">250</a> 		} <strong class="jxr_keyword">catch</strong> (<strong class="jxr_keyword">final</strong> Exception e) {
<a class="jxr_linenumber" name="L251" href="#L251">251</a> 			m_objLog.error(e);
<a class="jxr_linenumber" name="L252" href="#L252">252</a> 		}
<a class="jxr_linenumber" name="L253" href="#L253">253</a> 		<strong class="jxr_keyword">return</strong> user;
<a class="jxr_linenumber" name="L254" href="#L254">254</a> 	}
<a class="jxr_linenumber" name="L255" href="#L255">255</a> 
<a class="jxr_linenumber" name="L256" href="#L256">256</a> 	<em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L257" href="#L257">257</a> <em class="jxr_javadoccomment">	 * Gets the config value.</em>
<a class="jxr_linenumber" name="L258" href="#L258">258</a> <em class="jxr_javadoccomment">	 *</em>
<a class="jxr_linenumber" name="L259" href="#L259">259</a> <em class="jxr_javadoccomment">	 * @param key the key</em>
<a class="jxr_linenumber" name="L260" href="#L260">260</a> <em class="jxr_javadoccomment">	 * @return the config value</em>
<a class="jxr_linenumber" name="L261" href="#L261">261</a> <em class="jxr_javadoccomment">	 */</em>
<a class="jxr_linenumber" name="L262" href="#L262">262</a> 	<strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">static</strong> String getConfigValue(<strong class="jxr_keyword">final</strong> <a href="../../../../../../de/fraunhofer/fokus/oefit/adhoc/custom/E_ConfigKey.html">E_ConfigKey</a> key) {
<a class="jxr_linenumber" name="L263" href="#L263">263</a> 		String value = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L264" href="#L264">264</a> 		<strong class="jxr_keyword">if</strong> (key.isSystemProperty()) {
<a class="jxr_linenumber" name="L265" href="#L265">265</a> 			<strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L266" href="#L266">266</a> 				value = PrefsPropsUtil.getString(
<a class="jxr_linenumber" name="L267" href="#L267">267</a> 				        PortalUtil.getDefaultCompanyId(),
<a class="jxr_linenumber" name="L268" href="#L268">268</a> 				        key.getSystemProperty());
<a class="jxr_linenumber" name="L269" href="#L269">269</a> 				<em class="jxr_comment">// m_objLog.debug("Got portal property "+key.getSystemProperty()+" = "+value);</em>
<a class="jxr_linenumber" name="L270" href="#L270">270</a> 			} <strong class="jxr_keyword">catch</strong> (<strong class="jxr_keyword">final</strong> SystemException e) {
<a class="jxr_linenumber" name="L271" href="#L271">271</a> 				value = key.getDefaultValue();
<a class="jxr_linenumber" name="L272" href="#L272">272</a> 				m_objLog.error(e);
<a class="jxr_linenumber" name="L273" href="#L273">273</a> 			}
<a class="jxr_linenumber" name="L274" href="#L274">274</a> 		} <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L275" href="#L275">275</a> 			value = AHConfigLocalServiceUtil.getConfig(key.toString(),
<a class="jxr_linenumber" name="L276" href="#L276">276</a> 			        key.getDefaultValue());
<a class="jxr_linenumber" name="L277" href="#L277">277</a> 			<em class="jxr_comment">// m_objLog.debug("Got portlet property "+key.toString()+" = "+value);</em>
<a class="jxr_linenumber" name="L278" href="#L278">278</a> 		}
<a class="jxr_linenumber" name="L279" href="#L279">279</a> 		<strong class="jxr_keyword">return</strong> value;
<a class="jxr_linenumber" name="L280" href="#L280">280</a> 	}
<a class="jxr_linenumber" name="L281" href="#L281">281</a> 
<a class="jxr_linenumber" name="L282" href="#L282">282</a> 	<em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L283" href="#L283">283</a> <em class="jxr_javadoccomment">	 * Checks for user.</em>
<a class="jxr_linenumber" name="L284" href="#L284">284</a> <em class="jxr_javadoccomment">	 *</em>
<a class="jxr_linenumber" name="L285" href="#L285">285</a> <em class="jxr_javadoccomment">	 * @param companyId the company id</em>
<a class="jxr_linenumber" name="L286" href="#L286">286</a> <em class="jxr_javadoccomment">	 * @param mail the mail</em>
<a class="jxr_linenumber" name="L287" href="#L287">287</a> <em class="jxr_javadoccomment">	 * @return true, if successful</em>
<a class="jxr_linenumber" name="L288" href="#L288">288</a> <em class="jxr_javadoccomment">	 */</em>
<a class="jxr_linenumber" name="L289" href="#L289">289</a> 	<strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">boolean</strong> hasUser(<strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">long</strong> companyId, <strong class="jxr_keyword">final</strong> String mail) {
<a class="jxr_linenumber" name="L290" href="#L290">290</a> 		<strong class="jxr_keyword">boolean</strong> result = false;
<a class="jxr_linenumber" name="L291" href="#L291">291</a> 
<a class="jxr_linenumber" name="L292" href="#L292">292</a> 		<strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L293" href="#L293">293</a> 			<strong class="jxr_keyword">final</strong> User user = UserLocalServiceUtil.getUserByEmailAddress(
<a class="jxr_linenumber" name="L294" href="#L294">294</a> 			        companyId,
<a class="jxr_linenumber" name="L295" href="#L295">295</a> 			        mail);
<a class="jxr_linenumber" name="L296" href="#L296">296</a> 			result = user != <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L297" href="#L297">297</a> 		} <strong class="jxr_keyword">catch</strong> (<strong class="jxr_keyword">final</strong> NoSuchUserException e) {
<a class="jxr_linenumber" name="L298" href="#L298">298</a> 			<em class="jxr_comment">// IGNORE</em>
<a class="jxr_linenumber" name="L299" href="#L299">299</a> 		} <strong class="jxr_keyword">catch</strong> (<strong class="jxr_keyword">final</strong> PortalException e) {
<a class="jxr_linenumber" name="L300" href="#L300">300</a> 			m_objLog.error(e);
<a class="jxr_linenumber" name="L301" href="#L301">301</a> 		} <strong class="jxr_keyword">catch</strong> (<strong class="jxr_keyword">final</strong> SystemException e) {
<a class="jxr_linenumber" name="L302" href="#L302">302</a> 			m_objLog.error(e);
<a class="jxr_linenumber" name="L303" href="#L303">303</a> 		}
<a class="jxr_linenumber" name="L304" href="#L304">304</a> 
<a class="jxr_linenumber" name="L305" href="#L305">305</a> 		<strong class="jxr_keyword">return</strong> result;
<a class="jxr_linenumber" name="L306" href="#L306">306</a> 	}
<a class="jxr_linenumber" name="L307" href="#L307">307</a> 
<a class="jxr_linenumber" name="L308" href="#L308">308</a> 	<em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L309" href="#L309">309</a> <em class="jxr_javadoccomment">	 * Checks if is system initialized.</em>
<a class="jxr_linenumber" name="L310" href="#L310">310</a> <em class="jxr_javadoccomment">	 *</em>
<a class="jxr_linenumber" name="L311" href="#L311">311</a> <em class="jxr_javadoccomment">	 * @return true, if is system initialized</em>
<a class="jxr_linenumber" name="L312" href="#L312">312</a> <em class="jxr_javadoccomment">	 */</em>
<a class="jxr_linenumber" name="L313" href="#L313">313</a> 	<strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">boolean</strong> isSystemInitialized() {
<a class="jxr_linenumber" name="L314" href="#L314">314</a> 		<strong class="jxr_keyword">if</strong> (m_bInitialized == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L315" href="#L315">315</a> 			<strong class="jxr_keyword">final</strong> String cfgVal = getConfigValue(E_ConfigKey.INITFLAG);
<a class="jxr_linenumber" name="L316" href="#L316">316</a> 			m_bInitialized = cfgVal != <strong class="jxr_keyword">null</strong> &amp;&amp; cfgVal.equals(<span class="jxr_string">"true"</span>);
<a class="jxr_linenumber" name="L317" href="#L317">317</a> 		}
<a class="jxr_linenumber" name="L318" href="#L318">318</a> 		<strong class="jxr_keyword">return</strong> m_bInitialized;
<a class="jxr_linenumber" name="L319" href="#L319">319</a> 	}
<a class="jxr_linenumber" name="L320" href="#L320">320</a> 
<a class="jxr_linenumber" name="L321" href="#L321">321</a> 	<em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L322" href="#L322">322</a> <em class="jxr_javadoccomment">	 * Save config.</em>
<a class="jxr_linenumber" name="L323" href="#L323">323</a> <em class="jxr_javadoccomment">	 *</em>
<a class="jxr_linenumber" name="L324" href="#L324">324</a> <em class="jxr_javadoccomment">	 * @param request the request</em>
<a class="jxr_linenumber" name="L325" href="#L325">325</a> <em class="jxr_javadoccomment">	 */</em>
<a class="jxr_linenumber" name="L326" href="#L326">326</a> 	<strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">void</strong> saveConfig(<strong class="jxr_keyword">final</strong> ActionRequest request) {
<a class="jxr_linenumber" name="L327" href="#L327">327</a> 		<strong class="jxr_keyword">final</strong> Enumeration&lt;String&gt; paramNames = request.getParameterNames();
<a class="jxr_linenumber" name="L328" href="#L328">328</a> 		<strong class="jxr_keyword">while</strong> (paramNames.hasMoreElements()) {
<a class="jxr_linenumber" name="L329" href="#L329">329</a> 			<strong class="jxr_keyword">final</strong> String keyName = paramNames.nextElement();
<a class="jxr_linenumber" name="L330" href="#L330">330</a> 			E_ConfigKey key = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L331" href="#L331">331</a> 			<strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L332" href="#L332">332</a> 				key = E_ConfigKey.valueOf(keyName);
<a class="jxr_linenumber" name="L333" href="#L333">333</a> 			} <strong class="jxr_keyword">catch</strong> (<strong class="jxr_keyword">final</strong> Throwable t) {
<a class="jxr_linenumber" name="L334" href="#L334">334</a> 			}
<a class="jxr_linenumber" name="L335" href="#L335">335</a> 			<strong class="jxr_keyword">if</strong> (key != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L336" href="#L336">336</a> 
<a class="jxr_linenumber" name="L337" href="#L337">337</a> 				<strong class="jxr_keyword">final</strong> String value = request.getParameter(keyName);
<a class="jxr_linenumber" name="L338" href="#L338">338</a> 				<strong class="jxr_keyword">if</strong> (value != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L339" href="#L339">339</a> 					<em class="jxr_comment">// m_objLog.debug("Accepting save parameter: "+keyName+" with value: "+value);</em>
<a class="jxr_linenumber" name="L340" href="#L340">340</a> 					<strong class="jxr_keyword">final</strong> String oldVal = getConfigValue(key);
<a class="jxr_linenumber" name="L341" href="#L341">341</a> 					<strong class="jxr_keyword">if</strong> (!oldVal.equals(value)) {
<a class="jxr_linenumber" name="L342" href="#L342">342</a> 						m_objLog.debug(<span class="jxr_string">"Setting changed parameter: "</span> + keyName);
<a class="jxr_linenumber" name="L343" href="#L343">343</a> 						setConfig(key, value);
<a class="jxr_linenumber" name="L344" href="#L344">344</a> 					}
<a class="jxr_linenumber" name="L345" href="#L345">345</a> 
<a class="jxr_linenumber" name="L346" href="#L346">346</a> 				} <em class="jxr_comment">/*</em>
<a class="jxr_linenumber" name="L347" href="#L347">347</a> <em class="jxr_comment">				 * else { m_objLog.debug("Accepting save parameter: "+keyName+</em>
<a class="jxr_linenumber" name="L348" href="#L348">348</a> <em class="jxr_comment">				 * " with empty value"); }</em>
<a class="jxr_linenumber" name="L349" href="#L349">349</a> <em class="jxr_comment">				 */</em>
<a class="jxr_linenumber" name="L350" href="#L350">350</a> 			} <em class="jxr_comment">/*</em>
<a class="jxr_linenumber" name="L351" href="#L351">351</a> <em class="jxr_comment">			 * else { m_objLog.debug("Ignoring save parameter: "+keyName); }</em>
<a class="jxr_linenumber" name="L352" href="#L352">352</a> <em class="jxr_comment">			 */</em>
<a class="jxr_linenumber" name="L353" href="#L353">353</a> 		}
<a class="jxr_linenumber" name="L354" href="#L354">354</a> 		<em class="jxr_comment">/*</em>
<a class="jxr_linenumber" name="L355" href="#L355">355</a> <em class="jxr_comment">		 * refresh modules that depend on fresh configuration settings</em>
<a class="jxr_linenumber" name="L356" href="#L356">356</a> <em class="jxr_comment">		 */</em>
<a class="jxr_linenumber" name="L357" href="#L357">357</a> 		MessageComposer.getInstance().refreshCfg();
<a class="jxr_linenumber" name="L358" href="#L358">358</a> 		SocialMediaFactory.refreshCfg();
<a class="jxr_linenumber" name="L359" href="#L359">359</a> 	}
<a class="jxr_linenumber" name="L360" href="#L360">360</a> 
<a class="jxr_linenumber" name="L361" href="#L361">361</a> 	<em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L362" href="#L362">362</a> <em class="jxr_javadoccomment">	 * Sets the config.</em>
<a class="jxr_linenumber" name="L363" href="#L363">363</a> <em class="jxr_javadoccomment">	 *</em>
<a class="jxr_linenumber" name="L364" href="#L364">364</a> <em class="jxr_javadoccomment">	 * @param key the key</em>
<a class="jxr_linenumber" name="L365" href="#L365">365</a> <em class="jxr_javadoccomment">	 * @param value the value</em>
<a class="jxr_linenumber" name="L366" href="#L366">366</a> <em class="jxr_javadoccomment">	 */</em>
<a class="jxr_linenumber" name="L367" href="#L367">367</a> 	<strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">void</strong> setConfig(<strong class="jxr_keyword">final</strong> <a href="../../../../../../de/fraunhofer/fokus/oefit/adhoc/custom/E_ConfigKey.html">E_ConfigKey</a> key, <strong class="jxr_keyword">final</strong> String value) {
<a class="jxr_linenumber" name="L368" href="#L368">368</a> 		<strong class="jxr_keyword">if</strong> (key.isSystemProperty()) {
<a class="jxr_linenumber" name="L369" href="#L369">369</a> 			updatePortalPreferences(key.getSystemProperty(), value);
<a class="jxr_linenumber" name="L370" href="#L370">370</a> 		} <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L371" href="#L371">371</a> 			AHConfigLocalServiceUtil.setConfig(key.toString(), value);
<a class="jxr_linenumber" name="L372" href="#L372">372</a> 		}
<a class="jxr_linenumber" name="L373" href="#L373">373</a> 
<a class="jxr_linenumber" name="L374" href="#L374">374</a> 	}
<a class="jxr_linenumber" name="L375" href="#L375">375</a> 
<a class="jxr_linenumber" name="L376" href="#L376">376</a> 	<em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L377" href="#L377">377</a> <em class="jxr_javadoccomment">	 * Update portal preferences.</em>
<a class="jxr_linenumber" name="L378" href="#L378">378</a> <em class="jxr_javadoccomment">	 *</em>
<a class="jxr_linenumber" name="L379" href="#L379">379</a> <em class="jxr_javadoccomment">	 * @param key the key</em>
<a class="jxr_linenumber" name="L380" href="#L380">380</a> <em class="jxr_javadoccomment">	 * @param value the value</em>
<a class="jxr_linenumber" name="L381" href="#L381">381</a> <em class="jxr_javadoccomment">	 */</em>
<a class="jxr_linenumber" name="L382" href="#L382">382</a> 	<strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">void</strong> updatePortalPreferences(<strong class="jxr_keyword">final</strong> String key,
<a class="jxr_linenumber" name="L383" href="#L383">383</a> 	        <strong class="jxr_keyword">final</strong> String value) {
<a class="jxr_linenumber" name="L384" href="#L384">384</a> 		<strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L385" href="#L385">385</a> 			<strong class="jxr_keyword">final</strong> List&lt;PortalPreferences&gt; prefs = PortalPreferencesLocalServiceUtil
<a class="jxr_linenumber" name="L386" href="#L386">386</a> 			        .getPortalPreferenceses(QueryUtil.ALL_POS,
<a class="jxr_linenumber" name="L387" href="#L387">387</a> 			                QueryUtil.ALL_POS);
<a class="jxr_linenumber" name="L388" href="#L388">388</a> 
<a class="jxr_linenumber" name="L389" href="#L389">389</a> 			<strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> PortalPreferences pref : prefs) {
<a class="jxr_linenumber" name="L390" href="#L390">390</a> 				<strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">long</strong> ownerId = pref.getOwnerId();
<a class="jxr_linenumber" name="L391" href="#L391">391</a> 				<strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">int</strong> ownerType = pref.getOwnerType();
<a class="jxr_linenumber" name="L392" href="#L392">392</a> 				<em class="jxr_comment">// m_objLog.debug("Pref is "+ownerId+","+ownerType+","+pref.getPortalPreferencesId());</em>
<a class="jxr_linenumber" name="L393" href="#L393">393</a> 				<strong class="jxr_keyword">final</strong> PortletPreferences pps = PortalPreferencesLocalServiceUtil
<a class="jxr_linenumber" name="L394" href="#L394">394</a> 				        .getPreferences(ownerId, ownerType);
<a class="jxr_linenumber" name="L395" href="#L395">395</a> 				<strong class="jxr_keyword">final</strong> Enumeration&lt;String&gt; names = pps.getNames();
<a class="jxr_linenumber" name="L396" href="#L396">396</a> 				<strong class="jxr_keyword">while</strong> (names.hasMoreElements()) {
<a class="jxr_linenumber" name="L397" href="#L397">397</a> 					<strong class="jxr_keyword">final</strong> String pkey = names.nextElement();
<a class="jxr_linenumber" name="L398" href="#L398">398</a> 					<strong class="jxr_keyword">if</strong> (pkey.equals(key)) {
<a class="jxr_linenumber" name="L399" href="#L399">399</a> 						<em class="jxr_comment">// m_objLog.debug("Found property "+key+" with former value "+pps.getValue(key,"N/A"));</em>
<a class="jxr_linenumber" name="L400" href="#L400">400</a> 						pps.setValue(pkey, value);
<a class="jxr_linenumber" name="L401" href="#L401">401</a> 						pps.store();
<a class="jxr_linenumber" name="L402" href="#L402">402</a> 						<strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L403" href="#L403">403</a> 					}
<a class="jxr_linenumber" name="L404" href="#L404">404</a> 				}
<a class="jxr_linenumber" name="L405" href="#L405">405</a> 			}
<a class="jxr_linenumber" name="L406" href="#L406">406</a> 		} <strong class="jxr_keyword">catch</strong> (<strong class="jxr_keyword">final</strong> Throwable e) {
<a class="jxr_linenumber" name="L407" href="#L407">407</a> 			m_objLog.error(e);
<a class="jxr_linenumber" name="L408" href="#L408">408</a> 		}
<a class="jxr_linenumber" name="L409" href="#L409">409</a> 	}
<a class="jxr_linenumber" name="L410" href="#L410">410</a> }
</pre>
<hr/>
<div id="footer">Copyright &#169; 2015 <a href="http://www.fokus.fraunhofer.de">Fraunhofer FOKUS</a>. All rights reserved.</div>
</body>
</html>
